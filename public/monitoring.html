<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸŒ± Organic Traffic Monitoring</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Additional styles for monitoring page */
        .monitoring-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .session-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            border-left: 5px solid #27ae60;
        }
        
        .session-card.stopped {
            border-left-color: #e74c3c;
        }
        
        .session-card.error {
            border-left-color: #f39c12;
        }
        
        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .session-id {
            font-family: monospace;
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        .session-status {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .status-running { background: #d5f4e6; color: #27ae60; }
        .status-stopped { background: #fadbd8; color: #e74c3c; }
        .status-error { background: #fef5e7; color: #f39c12; }
        
        .session-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .detail-item {
            display: flex;
            flex-direction: column;
        }
        
        .detail-label {
            font-size: 0.8rem;
            color: #7f8c8d;
            margin-bottom: 2px;
        }
        
        .detail-value {
            font-weight: 600;
            color: #2c3e50;
            word-break: break-word;
        }
        
        .keywords-container {
            margin: 10px 0;
        }
        
        .keyword-tag {
            display: inline-block;
            background: #e8f6f3;
            color: #27ae60;
            padding: 3px 10px;
            margin: 2px 5px 2px 0;
            border-radius: 15px;
            font-size: 0.85rem;
        }
        
        .log-container {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.85rem;
        }
        
        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .log-timestamp {
            color: #7f8c8d;
            margin-right: 10px;
        }
        
        .log-step {
            color: #3498db;
            font-weight: 600;
            margin-right: 10px;
        }
        
        .log-message {
            color: #2c3e50;
        }
        
        .control-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .btn-small {
            padding: 5px 15px;
            font-size: 0.85rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            margin: 10px 0;
        }
        
        .stat-number.running { color: #27ae60; }
        .stat-number.stopped { color: #e74c3c; }
        .stat-number.total { color: #3498db; }
        
        .refresh-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 10px;
        }
        
        .last-refresh {
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            font-style: italic;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            font-weight: 600;
            color: #7f8c8d;
        }
        
        .tab.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .session-type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 5px;
        }
        
        .type-organic { background: #d5f4e6; color: #27ae60; }
        .type-direct { background: #e8f4fc; color: #3498db; }
        
        .bot-detection-count {
            display: inline-block;
            background: #fef5e7;
            color: #f39c12;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            margin-left: 5px;
        }
        
        .proxy-info {
            background: #e8f4fc;
            padding: 8px;
            border-radius: 5px;
            margin: 5px 0;
            font-family: monospace;
            font-size: 0.85rem;
            word-break: break-all;
        }
        
        /* Notification styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            z-index: 10000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="monitoring-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1><i class="fas fa-chart-line"></i> Organic Traffic Monitoring</h1>
                    <p>Real-time session monitoring & system analytics</p>
                </div>
                <div>
                    <button class="btn btn-primary" onclick="goToDashboard()">
                        <i class="fas fa-home"></i> Dashboard
                    </button>
                </div>
            </div>
            
            <div class="stats-grid" id="summaryStats">
                <div class="stat-card">
                    <div class="stat-label">Active Sessions</div>
                    <div class="stat-number running" id="activeSessionsCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Sessions</div>
                    <div class="stat-number total" id="totalSessionsCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Bot Detections</div>
                    <div class="stat-number" id="botDetectionsCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Working Proxies</div>
                    <div class="stat-number" id="workingProxiesCount">0</div>
                </div>
            </div>
        </div>
        
        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('sessions')">Active Sessions</div>
            <div class="tab" onclick="switchTab('stopped')">Stopped Sessions</div>
            <div class="tab" onclick="switchTab('system')">System Health</div>
            <div class="tab" onclick="switchTab('proxy')">Proxy Manager</div>
        </div>
        
        <!-- Refresh Controls -->
        <div class="refresh-controls">
            <div>
                <button class="btn btn-primary" onclick="loadAllData()">
                    <i class="fas fa-sync-alt"></i> Refresh All
                </button>
                <button class="btn btn-secondary" onclick="refreshSessions()">
                    <i class="fas fa-redo"></i> Refresh Sessions
                </button>
                <button class="btn btn-warning" onclick="stopAllSessions()">
                    <i class="fas fa-stop-circle"></i> Stop All Sessions
                </button>
                <button class="btn btn-info" onclick="exportLogs()">
                    <i class="fas fa-download"></i> Export Logs
                </button>
            </div>
            <div class="last-refresh">
                Last refresh: <span id="lastRefreshTime">Never</span>
                <br>
                Auto-refresh: <span id="autoRefreshStatus">ON (60s)</span>
            </div>
        </div>
        
        <!-- Sessions Tab -->
        <div id="sessionsTab" class="tab-content active">
            <h2><i class="fas fa-play-circle"></i> Active Sessions</h2>
            <div id="activeSessionsContainer">
                <div class="no-data">No active sessions. Start a session from the dashboard.</div>
            </div>
        </div>
        
        <!-- Stopped Sessions Tab -->
        <div id="stoppedTab" class="tab-content">
            <h2><i class="fas fa-stop-circle"></i> Stopped Sessions</h2>
            <div id="stoppedSessionsContainer">
                <div class="no-data">No stopped sessions.</div>
            </div>
        </div>
        
        <!-- System Health Tab -->
        <div id="systemTab" class="tab-content">
            <h2><i class="fas fa-heartbeat"></i> System Health</h2>
            <div class="session-card">
                <h3><i class="fas fa-server"></i> Server Status</h3>
                <div id="serverStatusDetails">
                    Loading server status...
                </div>
            </div>
            
            <div class="session-card">
                <h3><i class="fas fa-sync-alt"></i> Auto-Loop Status</h3>
                <div id="autoLoopStatusDetails">
                    Loading auto-loop status...
                </div>
            </div>
            
            <div class="session-card">
                <h3><i class="fas fa-robot"></i> Bot Detection Stats</h3>
                <div id="botDetectionStats">
                    Loading bot detection stats...
                </div>
            </div>
        </div>
        
        <!-- Proxy Manager Tab -->
        <div id="proxyTab" class="tab-content">
            <h2><i class="fas fa-network-wired"></i> Proxy Manager</h2>
            
            <div class="session-card">
                <h3><i class="fas fa-sync-alt"></i> Proxy Refresh</h3>
                <div style="display: flex; gap: 10px; margin: 15px 0;">
                    <button class="btn btn-primary" onclick="refreshProxies()">
                        <i class="fas fa-redo"></i> Refresh All Proxies
                    </button>
                    <button class="btn btn-secondary" onclick="testAllProxies()">
                        <i class="fas fa-vial"></i> Test All Proxies
                    </button>
                </div>
                <div class="proxy-info" id="proxyRefreshStatus">
                    Last proxy refresh: Never
                </div>
            </div>
            
            <div class="session-card">
                <h3><i class="fas fa-chart-pie"></i> Proxy Statistics</h3>
                <div id="proxyStatsDetails">
                    Loading proxy statistics...
                </div>
            </div>
            
            <div class="session-card">
                <h3><i class="fas fa-list"></i> Available Proxies by Type</h3>
                <div id="proxyTypeDetails">
                    Loading proxy types...
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let autoRefreshInterval = null;
        let lastRefreshTime = null;
        
        // DOM Ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Monitoring page loaded');
            
            // Load initial data
            loadAllData();
            
            // Start auto-refresh
            startAutoRefresh();
            
            // Update last refresh time
            updateLastRefreshTime();
        });
        
        // ==================== TAB MANAGEMENT ====================
        function switchTab(tabName) {
            // Update tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Activate selected tab
            const tabElement = document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`);
            const contentElement = document.getElementById(`${tabName}Tab`);
            
            if (tabElement) tabElement.classList.add('active');
            if (contentElement) contentElement.classList.add('active');
            
            // Load specific data for tab
            switch(tabName) {
                case 'sessions':
                    loadSessions();
                    break;
                case 'stopped':
                    loadStoppedSessions();
                    break;
                case 'system':
                    loadSystemHealth();
                    break;
                case 'proxy':
                    loadProxyManager();
                    break;
            }
        }
        
        // ==================== AUTO REFRESH ====================
        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            autoRefreshInterval = setInterval(() => {
                loadAllData();
            }, 60000); // 60 seconds
            
            document.getElementById('autoRefreshStatus').textContent = 'ON (60s)';
        }
        
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                document.getElementById('autoRefreshStatus').textContent = 'OFF';
            }
        }
        
        function updateLastRefreshTime() {
            const now = new Date();
            lastRefreshTime = now;
            document.getElementById('lastRefreshTime').textContent = 
                now.toLocaleTimeString('id-ID');
        }
        
        // ==================== DATA LOADING ====================
        function loadAllData() {
            console.log('Loading all monitoring data...');
            
            // Load sessions
            loadSessions();
            
            // Load system health
            loadSystemHealth();
            
            // Load proxy manager data
            loadProxyManager();
            
            // Update refresh time
            updateLastRefreshTime();
        }
        
        function loadSessions() {
            fetch('/api/all-sessions')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displaySessions(data.sessions);
                        updateSummaryStats(data.sessions);
                    } else {
                        showNotification(`Error loading sessions: ${data.error}`, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error loading sessions:', error);
                    showNotification('Network error loading sessions', 'error');
                });
        }
        
        function loadStoppedSessions() {
            fetch('/api/all-sessions')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const stoppedSessions = data.sessions.filter(s => s.status === 'stopped');
                        displayStoppedSessions(stoppedSessions);
                    }
                })
                .catch(error => {
                    console.error('Error loading stopped sessions:', error);
                });
        }
        
        function loadSystemHealth() {
            fetch('/api/system/health')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displaySystemHealth(data);
                    }
                })
                .catch(error => {
                    console.error('Error loading system health:', error);
                });
            
            // Load auto-loop status
            fetch('/api/auto-loop/status')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayAutoLoopStatus(data);
                    }
                })
                .catch(error => {
                    console.error('Error loading auto-loop status:', error);
                });
        }
        
        function loadProxyManager() {
            fetch('/api/proxies/status')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayProxyManager(data);
                    }
                })
                .catch(error => {
                    console.error('Error loading proxy manager:', error);
                });
        }
        
        function refreshSessions() {
            loadSessions();
            showNotification('Sessions refreshed', 'success');
        }
        
        // ==================== SESSION DISPLAY ====================
        function displaySessions(sessions) {
            const container = document.getElementById('activeSessionsContainer');
            
            if (!container) return;
            
            // Filter active sessions
            const activeSessions = sessions.filter(s => s.status === 'running');
            
            if (activeSessions.length === 0) {
                container.innerHTML = '<div class="no-data">No active sessions. Start a session from the dashboard.</div>';
                return;
            }
            
            let html = '';
            
            activeSessions.forEach(session => {
                html += createSessionCard(session);
            });
            
            container.innerHTML = html;
            
            // Add event listeners
            attachSessionEventListeners();
        }
        
        function displayStoppedSessions(sessions) {
            const container = document.getElementById('stoppedSessionsContainer');
            
            if (!container) return;
            
            if (sessions.length === 0) {
                container.innerHTML = '<div class="no-data">No stopped sessions.</div>';
                return;
            }
            
            let html = '';
            
            sessions.forEach(session => {
                html += createSessionCard(session);
            });
            
            container.innerHTML = html;
            
            // Add event listeners
            attachSessionEventListeners();
        }
        
        function attachSessionEventListeners() {
            // Add event listeners to view logs buttons
            document.querySelectorAll('.view-logs-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const sessionId = this.getAttribute('data-session-id');
                    viewSessionLogs(sessionId);
                });
            });
            
            // Add event listeners to stop buttons
            document.querySelectorAll('.stop-session-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const sessionId = this.getAttribute('data-session-id');
                    stopSession(sessionId);
                });
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-session-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const sessionId = this.getAttribute('data-session-id');
                    deleteSession(sessionId);
                });
            });
        }
        
        function createSessionCard(session) {
            const isRunning = session.status === 'running';
            const isOrganic = session.isOrganic === true;
            const sessionDuration = session.startTime ? 
                calculateDuration(session.startTime, session.endTime || new Date()) : 'N/A';
            
            // Format proxy info
            let proxyInfo = 'No proxy';
            if (session.proxyInfo) {
                if (session.proxyInfo.url) {
                    proxyInfo = session.proxyInfo.url;
                } else if (session.proxyInfo.host && session.proxyInfo.port) {
                    proxyInfo = `${session.proxyInfo.host}:${session.proxyInfo.port}`;
                } else if (session.proxyInfo.name) {
                    proxyInfo = session.proxyInfo.name;
                }
            }
            
            // Format keywords
            let keywordsHtml = '';
            if (session.keywords && session.keywords.length > 0) {
                keywordsHtml = '<div class="keywords-container">';
                session.keywords.slice(0, 5).forEach(keyword => {
                    keywordsHtml += `<span class="keyword-tag">${keyword}</span>`;
                });
                if (session.keywords.length > 5) {
                    keywordsHtml += `<span class="keyword-tag">+${session.keywords.length - 5} more</span>`;
                }
                keywordsHtml += '</div>';
            }
            
            // Format time multiplier
            const timeMultiplier = session.config?.timeMultiplier || 1.0;
            const multiplierText = timeMultiplier !== 1.0 ? 
                `(${timeMultiplier}x time)` : '';
            
            return `
                <div class="session-card ${!isRunning ? 'stopped' : ''}">
                    <div class="session-header">
                        <div>
                            <span class="session-id">${session.id.substring(0, 15)}...</span>
                            <span class="session-status status-${session.status}">
                                ${session.status.toUpperCase()}
                            </span>
                            ${isOrganic ? 
                                '<span class="session-type-badge type-organic">ðŸŒ± ORGANIC</span>' : 
                                '<span class="session-type-badge type-direct">DIRECT</span>'
                            }
                            ${session.botDetectionCount > 0 ? 
                                `<span class="bot-detection-count">ðŸ¤– ${session.botDetectionCount} detections</span>` : 
                                ''
                            }
                        </div>
                        <div class="control-buttons">
                            <button class="btn btn-small btn-primary view-logs-btn" data-session-id="${session.id}">
                                <i class="fas fa-scroll"></i> View Logs
                            </button>
                            ${isRunning ? `
                                <button class="btn btn-small btn-warning stop-session-btn" data-session-id="${session.id}">
                                    <i class="fas fa-stop"></i> Stop
                                </button>
                            ` : `
                                <button class="btn btn-small btn-danger delete-session-btn" data-session-id="${session.id}">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            `}
                        </div>
                    </div>
                    
                    <div class="session-details">
                        <div class="detail-item">
                            <span class="detail-label">Started</span>
                            <span class="detail-value">${formatDateTime(session.startTime)} ${multiplierText}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Duration</span>
                            <span class="detail-value">${sessionDuration}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Target URL</span>
                            <span class="detail-value">${session.config?.targetUrl || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Search Engine</span>
                            <span class="detail-value">${session.searchEngine || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Device</span>
                            <span class="detail-value">${session.config?.deviceType || 'desktop'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Current Step</span>
                            <span class="detail-value">${session.currentStep || 'Idle'}</span>
                        </div>
                    </div>
                    
                    <div class="detail-item">
                        <span class="detail-label">Proxy</span>
                        <div class="proxy-info">${proxyInfo}</div>
                    </div>
                    
                    ${keywordsHtml}
                    
                    <div class="log-container" id="logs-${session.id}" style="display: none;">
                        Loading logs...
                    </div>
                </div>
            `;
        }
        
        // ==================== SESSION ACTIONS ====================
        function stopSession(sessionId) {
            if (!confirm('Are you sure you want to stop this session?')) {
                return;
            }
            
            fetch(`/api/stop-session/${sessionId}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Session stopped successfully', 'success');
                    loadSessions(); // Refresh the list
                } else {
                    showNotification(`Error stopping session: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error stopping session:', error);
                showNotification('Network error stopping session', 'error');
            });
        }
        
        function stopAllSessions() {
            if (!confirm('Are you sure you want to stop ALL active sessions?')) {
                return;
            }
            
            fetch('/api/stop-all-sessions', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('All sessions stopped', 'success');
                    loadSessions(); // Refresh the list
                } else {
                    showNotification(`Error stopping all sessions: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error stopping all sessions:', error);
                showNotification('Network error stopping sessions', 'error');
            });
        }
        
        function deleteSession(sessionId) {
            if (!confirm('Are you sure you want to delete this session?')) {
                return;
            }
            
            // For now, we'll just reload which will clear it from display
            // In a real implementation, you'd have a delete endpoint
            showNotification('Session deleted from view', 'info');
            loadStoppedSessions();
        }
        
        function viewSessionLogs(sessionId) {
            const logContainer = document.getElementById(`logs-${sessionId}`);
            
            if (!logContainer) return;
            
            // Toggle visibility
            if (logContainer.style.display === 'none') {
                logContainer.style.display = 'block';
                
                // Load logs if not already loaded
                if (logContainer.textContent === 'Loading logs...') {
                    fetch(`/api/session-logs/${sessionId}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.success && data.logs) {
                                displaySessionLogs(sessionId, data.logs);
                            } else {
                                logContainer.innerHTML = '<div class="no-data">No logs available</div>';
                            }
                        })
                        .catch(error => {
                            console.error('Error loading logs:', error);
                            logContainer.innerHTML = '<div class="no-data">Error loading logs</div>';
                        });
                }
            } else {
                logContainer.style.display = 'none';
            }
        }
        
        function displaySessionLogs(sessionId, logs) {
            const logContainer = document.getElementById(`logs-${sessionId}`);
            
            if (!logContainer || !logs || logs.length === 0) {
                if (logContainer) {
                    logContainer.innerHTML = '<div class="no-data">No logs available</div>';
                }
                return;
            }
            
            let html = '';
            
            // Show latest 20 logs
            logs.slice(-20).forEach(log => {
                html += `
                    <div class="log-entry">
                        <span class="log-timestamp">${log.timestamp}</span>
                        <span class="log-step">${log.step}</span>
                        <span class="log-message">${log.message}</span>
                    </div>
                `;
            });
            
            if (logs.length > 20) {
                html += `<div style="text-align: center; color: #7f8c8d; padding: 10px;">
                    Showing latest 20 of ${logs.length} logs
                </div>`;
            }
            
            logContainer.innerHTML = html;
            
            // Scroll to bottom
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // ==================== SYSTEM HEALTH DISPLAY ====================
        function displaySystemHealth(data) {
            const container = document.getElementById('serverStatusDetails');
            
            if (!container) return;
            
            const memory = data.system.memory;
            const uptime = data.system.uptime;
            const hours = Math.floor(uptime / 3600);
            const minutes = Math.floor((uptime % 3600) / 60);
            
            const sessions = data.sessions;
            
            container.innerHTML = `
                <div class="session-details">
                    <div class="detail-item">
                        <span class="detail-label">Uptime</span>
                        <span class="detail-value">${hours}h ${minutes}m</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Memory Usage</span>
                        <span class="detail-value">${memory.heapUsed}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Node Version</span>
                        <span class="detail-value">${data.system.nodeVersion}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Platform</span>
                        <span class="detail-value">${data.system.platform}</span>
                    </div>
                </div>
                <div class="session-details">
                    <div class="detail-item">
                        <span class="detail-label">Running Sessions</span>
                        <span class="detail-value">${sessions.running}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Stopped Sessions</span>
                        <span class="detail-value">${sessions.stopped}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Error Sessions</span>
                        <span class="detail-value">${sessions.error}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Total Sessions</span>
                        <span class="detail-value">${sessions.total}</span>
                    </div>
                </div>
            `;
        }
        
        function displayAutoLoopStatus(data) {
            const container = document.getElementById('autoLoopStatusDetails');
            
            if (!container) return;
            
            const isEnabled = data.config.enabled;
            const activeSessions = data.activeSessions;
            const maxSessions = data.config.maxSessions;
            const interval = data.config.interval / 60000; // Convert to minutes
            
            container.innerHTML = `
                <div class="session-details">
                    <div class="detail-item">
                        <span class="detail-label">Status</span>
                        <span class="detail-value">
                            ${isEnabled ? 
                                '<span style="color: #27ae60;">ðŸŸ¢ RUNNING</span>' : 
                                '<span style="color: #e74c3c;">ðŸ”´ STOPPED</span>'
                            }
                        </span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Interval</span>
                        <span class="detail-value">${interval} minutes</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Active Sessions</span>
                        <span class="detail-value">${activeSessions}/${maxSessions}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Target URL</span>
                        <span class="detail-value">${data.config.targetUrl || 'Not set'}</span>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    ${isEnabled ? 
                        `<button class="btn btn-warning" onclick="stopAutoLoopFromMonitor()">
                            <i class="fas fa-stop-circle"></i> Stop Auto-Loop
                        </button>` :
                        `<button class="btn btn-success" onclick="startAutoLoopFromMonitor()">
                            <i class="fas fa-play-circle"></i> Start Auto-Loop
                        </button>`
                    }
                </div>
            `;
        }
        
        // ==================== PROXY MANAGER DISPLAY ====================
        function displayProxyManager(data) {
            displayProxyStats(data);
            displayProxyTypes(data);
            
            // Update proxy refresh status
            if (data.lastUpdate) {
                const updateTime = new Date(data.lastUpdate);
                const now = new Date();
                const diffMinutes = Math.floor((now - updateTime) / (1000 * 60));
                
                let timeText = 'Just now';
                if (diffMinutes > 0) {
                    timeText = `${diffMinutes} minutes ago`;
                }
                
                document.getElementById('proxyRefreshStatus').textContent = 
                    `Last proxy refresh: ${timeText}`;
            }
        }
        
        function displayProxyStats(data) {
            const container = document.getElementById('proxyStatsDetails');
            
            if (!container) return;
            
            const stats = data.stats;
            const totalWorking = stats?.totalWorking || 0;
            const freshWorking = stats?.fresh?.working || 0;
            const freshTotal = stats?.fresh?.total || 0;
            const vpnWorking = stats?.vpn?.working || 0;
            
            container.innerHTML = `
                <div class="session-details">
                    <div class="detail-item">
                        <span class="detail-label">Total Working</span>
                        <span class="detail-value" style="font-size: 1.5rem; color: #27ae60;">${totalWorking}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Fresh Proxies</span>
                        <span class="detail-value">${freshWorking}/${freshTotal}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">VPN Extensions</span>
                        <span class="detail-value">${vpnWorking}</span>
                    </div>
                </div>
                ${stats?.fresh?.proxies && stats.fresh.proxies.length > 0 ? `
                    <div style="margin-top: 15px;">
                        <h4>Fastest Proxies:</h4>
                        <div style="max-height: 150px; overflow-y: auto; font-family: monospace; font-size: 0.85rem;">
                            ${stats.fresh.proxies.slice(0, 5).map((proxy, index) => `
                                <div style="padding: 5px; border-bottom: 1px solid #e0e0e0;">
                                    ${index + 1}. ${proxy.host}:${proxy.port} 
                                    <span style="color: #7f8c8d;">(${proxy.type})</span>
                                    <span style="float: right; color: #27ae60;">${proxy.speed}ms</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
            `;
        }
        
        function displayProxyTypes(data) {
            const container = document.getElementById('proxyTypeDetails');
            
            if (!container) return;
            
            // Group proxies by type
            const proxiesByType = {};
            if (data.freshProxies) {
                data.freshProxies.forEach(proxy => {
                    const type = proxy.type || 'unknown';
                    if (!proxiesByType[type]) {
                        proxiesByType[type] = [];
                    }
                    proxiesByType[type].push(proxy);
                });
            }
            
            let html = '';
            
            Object.entries(proxiesByType).forEach(([type, proxies]) => {
                const count = proxies.length;
                
                html += `
                    <div style="margin-bottom: 15px;">
                        <h4>${type.toUpperCase()} (${count})</h4>
                        <div style="max-height: 120px; overflow-y: auto; font-family: monospace; font-size: 0.8rem;">
                            ${proxies.slice(0, 10).map(proxy => `
                                <div style="padding: 3px; border-bottom: 1px solid #e0e0e0;">
                                    ${proxy.host}:${proxy.port}
                                    ${proxy.username ? ` [${proxy.username}]` : ''}
                                </div>
                            `).join('')}
                            ${count > 10 ? `<div style="color: #7f8c8d; text-align: center; padding: 5px;">
                                ... and ${count - 10} more
                            </div>` : ''}
                        </div>
                    </div>
                `;
            });
            
            if (html === '') {
                html = '<div class="no-data">No proxies available</div>';
            }
            
            container.innerHTML = html;
        }
        
        function refreshProxies() {
            fetch('/api/proxies/refresh', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Proxies refreshed successfully', 'success');
                    loadProxyManager();
                } else {
                    showNotification(`Error refreshing proxies: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error refreshing proxies:', error);
                showNotification('Network error refreshing proxies', 'error');
            });
        }
        
        function testAllProxies() {
            showNotification('Testing all proxies... This may take a while.', 'info');
            
            // Note: You would need to implement a test endpoint in your server
            // For now, we'll just refresh which includes testing
            refreshProxies();
        }
        
        // ==================== SUMMARY STATS ====================
        function updateSummaryStats(sessions) {
            const activeSessions = sessions.filter(s => s.status === 'running').length;
            const totalSessions = sessions.length;
            
            // Calculate total bot detections
            let botDetections = 0;
            sessions.forEach(session => {
                if (session.botDetectionCount) {
                    botDetections += session.botDetectionCount;
                }
            });
            
            document.getElementById('activeSessionsCount').textContent = activeSessions;
            document.getElementById('totalSessionsCount').textContent = totalSessions;
            document.getElementById('botDetectionsCount').textContent = botDetections;
            
            // We'll update proxy count separately when proxy data loads
        }
        
        // ==================== UTILITY FUNCTIONS ====================
        function formatDateTime(dateString) {
            if (!dateString) return 'N/A';
            
            const date = new Date(dateString);
            return date.toLocaleString('id-ID', {
                day: '2-digit',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function calculateDuration(start, end) {
            if (!start) return 'N/A';
            
            const startTime = new Date(start);
            const endTime = end ? new Date(end) : new Date();
            
            const diffMs = endTime - startTime;
            const diffSeconds = Math.floor(diffMs / 1000);
            const diffMinutes = Math.floor(diffSeconds / 60);
            const diffHours = Math.floor(diffMinutes / 60);
            
            if (diffHours > 0) {
                return `${diffHours}h ${diffMinutes % 60}m`;
            } else if (diffMinutes > 0) {
                return `${diffMinutes}m ${diffSeconds % 60}s`;
            } else {
                return `${diffSeconds}s`;
            }
        }
        
        function goToDashboard() {
            window.location.href = '/';
        }
        
        function exportLogs() {
            // For now, just show a notification
            // In a real implementation, you would generate and download a log file
            showNotification('Export feature coming soon!', 'info');
        }
        
        function showNotification(message, type = 'info', duration = 5000) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                background: ${type === 'success' ? '#27ae60' : type === 'error' ? '#e74c3c' : '#3498db'};
                color: white;
                border-radius: 5px;
                z-index: 10000;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                animation: slideIn 0.3s ease;
            `;
            
            // Add to body
            document.body.appendChild(notification);
            
            // Auto remove
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease forwards';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, duration);
        }
        
        // ==================== AUTO-LOOP CONTROL FROM MONITOR ====================
        function stopAutoLoopFromMonitor() {
            if (!confirm('Are you sure you want to stop the organic auto-loop?')) {
                return;
            }
            
            fetch('/api/auto-loop/stop', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Auto-loop stopped', 'success');
                    loadSystemHealth(); // Refresh status
                } else {
                    showNotification(`Error: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                showNotification(`Network error: ${error.message}`, 'error');
            });
        }
        
        function startAutoLoopFromMonitor() {
            // Get current target URL from system health or use default
            const targetUrl = prompt('Enter target URL for auto-loop:', 'https://cryptoajah.blogspot.com');
            
            if (!targetUrl) return;
            
            fetch('/api/auto-loop/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    targetUrl: targetUrl,
                    interval: 45 * 60 * 1000, // 45 minutes
                    maxSessions: 3,
                    organicOnly: true
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Auto-loop started!', 'success');
                    loadSystemHealth(); // Refresh status
                } else {
                    showNotification(`Error: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                showNotification(`Network error: ${error.message}`, 'error');
            });
        }
    </script>
</body>
</html>